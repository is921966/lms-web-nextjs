#!/usr/bin/env node

const { createClient } = require('@supabase/supabase-js');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è');
  console.log('–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env.local —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:');
  console.log('NEXT_PUBLIC_SUPABASE_URL=your-supabase-url');
  console.log('SUPABASE_SERVICE_ROLE_KEY=your-service-role-key');
  process.exit(1);
}

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

async function checkAndPopulateFeed() {
  console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...\n');

  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π
    const { data: profiles, error: profileError } = await supabase
      .from('profiles')
      .select('*');

    if (profileError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:', profileError.message);
      console.log('–í–æ–∑–º–æ–∂–Ω–æ, —Ç–∞–±–ª–∏—Ü—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ docs/SUPABASE_MIGRATION_GUIDE.md');
      return;
    }

    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ—Ñ–∏–ª–µ–π: ${profiles?.length || 0}`);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–∞–Ω–∞–ª–æ–≤
    const { data: channels, error: channelError } = await supabase
      .from('feed_channels')
      .select('*');

    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–∞–ª–æ–≤: ${channels?.length || 0}`);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ—Å—Ç–æ–≤
    const { data: posts, error: postError } = await supabase
      .from('feed_posts')
      .select('*');

    console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ—Å—Ç–æ–≤: ${posts?.length || 0}\n`);

    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ
    if (!profiles?.length || !channels?.length || !posts?.length) {
      console.log('üìù –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...\n');
      await createTestData();
    } else {
      console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ!');
      console.log('\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–æ—Å—Ç–∞:');
      posts.slice(0, 3).forEach(post => {
        console.log(`- "${post.title}" (${new Date(post.published_at).toLocaleDateString('ru-RU')})`);
      });
    }

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error.message);
  }
}

async function createTestData() {
  try {
    // 1. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
    console.log('1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏...');
    const testProfiles = [
      {
        id: '550e8400-e29b-41d4-a716-446655440001',
        full_name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã',
        role: 'admin',
        department: 'IT',
        position: '–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'
      },
      {
        id: '550e8400-e29b-41d4-a716-446655440002',
        full_name: '–ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞',
        role: 'user',
        department: 'HR',
        position: 'HR –º–µ–Ω–µ–¥–∂–µ—Ä'
      },
      {
        id: '550e8400-e29b-41d4-a716-446655440003',
        full_name: '–ü–µ—Ç—Ä –°–∏–¥–æ—Ä–æ–≤',
        role: 'user',
        department: '–ü—Ä–æ–¥–∞–∂–∏',
        position: '–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º'
      }
    ];

    for (const profile of testProfiles) {
      const { error } = await supabase
        .from('profiles')
        .upsert(profile, { onConflict: 'id' });
      
      if (error && !error.message.includes('duplicate')) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è ${profile.full_name}:`, error.message);
      } else {
        console.log(`   ‚úÖ –ü—Ä–æ—Ñ–∏–ª—å ${profile.full_name} —Å–æ–∑–¥–∞–Ω`);
      }
    }

    // 2. –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª—ã
    console.log('\n2Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª—ã –ª–µ–Ω—Ç—ã...');
    const channels = [
      {
        id: '550e8400-e29b-41d4-a716-446655440101',
        name: '–ù–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏',
        slug: 'company-news',
        description: '–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        icon: 'üì¢',
        color: '#3B82F6',
        is_official: true,
        creator_id: '550e8400-e29b-41d4-a716-446655440001'
      },
      {
        id: '550e8400-e29b-41d4-a716-446655440102',
        name: '–û–±—É—á–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ',
        slug: 'learning',
        description: '–ù–æ–≤–æ—Å—Ç–∏ –æ –∫—É—Ä—Å–∞—Ö –∏ —Ç—Ä–µ–Ω–∏–Ω–≥–∞—Ö',
        icon: 'üìö',
        color: '#10B981',
        is_official: true,
        creator_id: '550e8400-e29b-41d4-a716-446655440001'
      },
      {
        id: '550e8400-e29b-41d4-a716-446655440103',
        name: 'HR –Ω–æ–≤–æ—Å—Ç–∏',
        slug: 'hr-news',
        description: '–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç HR –æ—Ç–¥–µ–ª–∞',
        icon: 'üë•',
        color: '#F59E0B',
        is_official: true,
        creator_id: '550e8400-e29b-41d4-a716-446655440002'
      }
    ];

    for (const channel of channels) {
      const { error } = await supabase
        .from('feed_channels')
        .upsert(channel, { onConflict: 'id' });
      
      if (error && !error.message.includes('duplicate')) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ ${channel.name}:`, error.message);
      } else {
        console.log(`   ‚úÖ –ö–∞–Ω–∞–ª "${channel.name}" —Å–æ–∑–¥–∞–Ω`);
      }
    }

    // 3. –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç—ã
    console.log('\n3Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã...');
    const posts = [
      {
        channel_id: '550e8400-e29b-41d4-a716-446655440101',
        author_id: '550e8400-e29b-41d4-a716-446655440001',
        title: '–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è',
        content: `–†–∞–¥—ã —Å–æ–æ–±—â–∏—Ç—å –æ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–π LMS –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã! 

–¢–µ–ø–µ—Ä—å –≤—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –º–æ–≥—É—Ç:
- –ü—Ä–æ—Ö–æ–¥–∏—Ç—å –∫—É—Ä—Å—ã –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è
- –ü–æ–ª—É—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

–ù–∞—á–Ω–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è!`,
        excerpt: '–ó–∞–ø—É—â–µ–Ω–∞ –Ω–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è',
        media_type: 'image',
        media_url: 'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=800',
        tags: ['–æ–±—É—á–µ–Ω–∏–µ', '–Ω–æ–≤–æ—Å—Ç–∏', '–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞'],
        published_at: new Date()
      },
      {
        channel_id: '550e8400-e29b-41d4-a716-446655440102',
        author_id: '550e8400-e29b-41d4-a716-446655440002',
        title: '–ù–æ–≤—ã–π –∫—É—Ä—Å: –û—Å–Ω–æ–≤—ã –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞',
        content: `–û—Ç–∫—Ä—ã—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫—É—Ä—Å "–û—Å–Ω–æ–≤—ã –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞"!

–í—ã –Ω–∞—É—á–∏—Ç–µ—Å—å:
‚úì –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã
‚úì –£–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–º–∞–Ω–¥–æ–π
‚úì –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–æ–∫–∏ –∏ –±—é–¥–∂–µ—Ç

–°—Ç–∞—Ä—Ç –∫—É—Ä—Å–∞: 1 –∞–≤–≥—É—Å—Ç–∞ 2025`,
        excerpt: '–û—Ç–∫—Ä—ã—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤—ã–π –∫—É—Ä—Å –ø–æ –ø—Ä–æ–µ–∫—Ç–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É',
        tags: ['–∫—É—Ä—Å—ã', '–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç', '–æ–±—É—á–µ–Ω–∏–µ'],
        published_at: new Date(Date.now() - 24 * 60 * 60 * 1000) // –≤—á–µ—Ä–∞
      },
      {
        channel_id: '550e8400-e29b-41d4-a716-446655440103',
        author_id: '550e8400-e29b-41d4-a716-446655440002',
        title: '–ì—Ä–∞—Ñ–∏–∫ –æ—Ç–ø—É—Å–∫–æ–≤ –Ω–∞ –∞–≤–≥—É—Å—Ç',
        content: `–ù–∞–ø–æ–º–∏–Ω–∞–µ–º –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Ç–ø—É—Å–∫ –¥–æ 31 –∏—é–ª—è.

–§–æ—Ä–º–∞ –∑–∞—è–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.

–ü—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–ø—É—Å–∫–∞ —É—á–∏—Ç—ã–≤–∞–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –≤–∞—à–µ–≥–æ –æ—Ç–¥–µ–ª–∞.`,
        excerpt: '–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ—Ç–ø—É—Å–∫ –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞',
        tags: ['hr', '–æ—Ç–ø—É—Å–∫', '–≤–∞–∂–Ω–æ'],
        published_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000) // 2 –¥–Ω—è –Ω–∞–∑–∞–¥
      },
      {
        channel_id: '550e8400-e29b-41d4-a716-446655440101',
        author_id: '550e8400-e29b-41d4-a716-446655440001',
        title: '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–≤–∞—Ä—Ç–∞–ª–∞',
        content: `–ü–æ–¥–≤–æ–¥–∏–º –∏—Ç–æ–≥–∏ –≤—Ç–æ—Ä–æ–≥–æ –∫–≤–∞—Ä—Ç–∞–ª–∞ 2025 –≥–æ–¥–∞.

–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:
üìà –†–æ—Å—Ç –ø—Ä–æ–¥–∞–∂ –Ω–∞ 15%
üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –Ω–∞ 112%
üë• –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ 20 —á–µ–ª–æ–≤–µ–∫

–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤—Å–µ—Ö –∑–∞ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É!`,
        excerpt: '–ö–æ–º–ø–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–ª–∞ –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ –≤—Ç–æ—Ä–æ–º –∫–≤–∞—Ä—Ç–∞–ª–µ',
        media_type: 'image',
        media_url: 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=800',
        tags: ['—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã', '–∫–≤–∞—Ä—Ç–∞–ª', '–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è'],
        published_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) // 3 –¥–Ω—è –Ω–∞–∑–∞–¥
      }
    ];

    for (const post of posts) {
      const { error } = await supabase
        .from('feed_posts')
        .insert(post);
      
      if (error) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ "${post.title}":`, error.message);
      } else {
        console.log(`   ‚úÖ –ü–æ—Å—Ç "${post.title}" —Å–æ–∑–¥–∞–Ω`);
      }
    }

    // 4. –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
    console.log('\n4Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã...');
    const subscriptions = [
      { user_id: '550e8400-e29b-41d4-a716-446655440001', channel_id: '550e8400-e29b-41d4-a716-446655440101' },
      { user_id: '550e8400-e29b-41d4-a716-446655440001', channel_id: '550e8400-e29b-41d4-a716-446655440102' },
      { user_id: '550e8400-e29b-41d4-a716-446655440002', channel_id: '550e8400-e29b-41d4-a716-446655440101' },
      { user_id: '550e8400-e29b-41d4-a716-446655440002', channel_id: '550e8400-e29b-41d4-a716-446655440103' },
      { user_id: '550e8400-e29b-41d4-a716-446655440003', channel_id: '550e8400-e29b-41d4-a716-446655440101' },
    ];

    for (const sub of subscriptions) {
      await supabase
        .from('feed_subscriptions')
        .upsert(sub, { onConflict: 'user_id,channel_id' });
    }
    console.log('   ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏ —Å–æ–∑–¥–∞–Ω—ã');

    console.log('\n‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã!');
    console.log('üåê –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–µ–Ω—Ç—É –Ω–æ–≤–æ—Å—Ç–µ–π');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error.message);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
checkAndPopulateFeed(); 